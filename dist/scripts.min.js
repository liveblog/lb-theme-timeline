!function(e){"use strict";function t(t,n,i,a,o,s,l,r,m,g){function d(){return v.pagesManager.retrieveUpdate().then(function(t){if(v.pagesManager.updateLatestDates(t._items),v.timeline)e.forEach(t._items,function(t){var n=!1;e.forEach(v.timeline.config.events,function(e){t._id===e._id&&(n=e.unique_id)}),n?"open"!==t.post_status||t.deleted?v.timeline.removeId(n):(v.timeline.removeId(n),v.timeline.add(u(t))):"open"===t.post_status&&v.timeline.add(u(t))});else{var n=[];e.forEach(t._items,function(e){"open"!==e.post_status||e.deleted||n.push(e)}),f(n)}})}function c(){i.get({},function(n){"closed"===n.blog_status&&(t.cancel(v.interval.posts),t.cancel(v.interval.blog)),e.extend(v.blog,n)})}function u(t){var n="",i="";e.forEach(t.items,function(e){i||"image"!==e.item_type&&"embed"!==e.item_type?n+=""==n?e.text:"<br />"+e.text:i="<blockquote>"+e.text+"</blockquote>"});var o={start_date:{month:moment(t.published_date).format("MM"),day:moment(t.published_date).format("D"),year:moment(t.published_date).format("YYYY"),hour:moment(t.published_date).format("H"),minute:moment(t.published_date).format("m")},_id:t._id,display_date:moment(t.published_date).format(a.settings.datetimeFormat),text:{text:n}};return i&&(o.media={url:i}),o}function f(t){if(v.timeline)e.forEach(t,function(e){v.timeline.add(u(e))});else if(t.length){var n={events:[]};e.forEach(t,function(e){n.events.push(u(e))}),v.timeline=new g.TL.Timeline("liveblog-timeline",n),v.timelineOn=!0}}var h=a.settings.postsPerPage,p=100,w=a.settings.permalinkDelimiter||"?",y=a.settings.postOrder,b=(a.settings.loadNewPostsManually,"boolean"==typeof a.settings.loadNewStickyPostsManually?a.settings.loadNewStickyPostsManually:a.settings.loadNewPostsManually,3e3),v=this,P=new n(h,y,(!1)),k=new l(P,w),M=new n(p,y,(!0)),O=new l(M,w);e.extend(v,{templateDir:a.assets_root,blog:r(a.blog),loading:!0,timelineOn:!1,finished:!1,highlightsOnly:!1,settings:a.settings,newPosts:[],newStickyPosts:[],sortOptions:[{name:m("Editorial"),order:"editorial"},{name:m("Newest first"),order:"newest_first"},{name:m("Oldest first"),order:"oldest_first"}],orderBy:function(e){v.loading=!0,v.finished=!1,v.pagesManager.changeOrder(e).then(function(e){v.loading=!1,v.finished=e._meta.total<=e._meta.max_results*e._meta.page})},fetchNewPage:function(){return v.loading=!0,v.pagesManager.fetchNewPage().then(function(e){v.finished=e._meta.total<=e._meta.max_results*e._meta.page,f(e._items),v.stickyPagesManager.fetchNewPage().then(function(e){v.loading=!1,f(e._items)})})},permalinkScroll:function(){v.loading=!0,v.permalink.loadPost().then(function(e){o(e),v.loading=!1},function(){v.loading=!1})},isAllowedToLoadMore:function(){return!v.loading&&!v.finished},applyUpdates:function(){P.applyUpdates(v.newPosts,!0),v.newPosts=[],M.applyUpdates(v.newStickyPosts,!0),v.newStickyPosts=[]},toggleHighlighsOnly:function(){v.highlightsOnly=!v.highlightsOnly,v.loading=!0,v.finished=!1,M.changeHighlight(v.highlightsOnly),P.changeHighlight(v.highlightsOnly).then(function(e){v.loading=!1,v.finished=e._meta.total<=e._meta.max_results*e._meta.page}),v.highlightsOnly&&(M.hideSticky=!1)},pagesManager:P,permalink:k,stickyPagesManager:M,stickyPermalink:O}),v.fetchNewPage().then(function(){function e(e){"loadMore"===e.data&&n()}v.permalinkScroll(),"closed"!==v.blog.blog_status&&(v.interval={posts:t(d,b),blog:t(c,3*b)});var n=_.debounce(v.fetchNewPage,1e3);window.addEventListener("message",e,!1)})}t.$inject=["$interval","PagesManager","blogs","config","$anchorScroll","$timeout","Permalink","transformBlog","gettext","$window"],e.module("theme",["liveblog-embed","ngAnimate","infinite-scroll","gettext"]).run(["gettextCatalog","config",function(e,t){e.setCurrentLanguage(t.settings.language)}]).run(["$rootScope",function(t){e.element(document).on("click",function(n){t.$broadcast("documentClicked",e.element(n.target))})}]).controller("TimelineCtrl",t).directive("lbItem",["asset",function(e){return{restrict:"AE",scope:{ident:"=",item:"="},templateUrl:e.templateUrl("views/item.html")}}]).directive("lbAuthor",["asset",function(e){return{restrict:"AE",scope:{item:"=",timeline:"="},templateUrl:e.templateUrl("views/author.html")}}]).directive("lbPosts",["asset",function(e){return{restrict:"E",scope:{posts:"=",timeline:"="},templateUrl:e.templateUrl("views/posts.html")}}]),e.module("infinite-scroll").value("THROTTLE_MILLISECONDS",1e3)}(angular);